<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test your pronunciation</title>
</head>
<body>
    <div>
        <div>
        <select id="voices" onchange="saveVoice()">
            <option value="">Select on voice</option>
        </select>
        </div>    
        <div>
            <textarea name="text" id="text" cols="30" rows="10"></textarea>
        </div>
        <div>
            <button onclick="speak()">Speak</button>
        </div>
    </div>
</body>
<script>
    var voices = [];
    function getVoices(){
        var resolvePromise;
        var promise = new Promise(r => resolvePromise = r);
        voices = window.speechSynthesis.getVoices();
        if (voices.length == 0) {
            new Promise(r => {
                window.speechSynthesis.onvoiceschanged = () => { 
                    window.speechSynthesis.onvoiceschanged = null;
                    r(); 
                };
            })
            .then((voices) => {
                getVoices()
            })
        }
        else{
            var voiceSaved = localStorage.getItem("voice");
            var select = document.getElementById("voices");
            voices.forEach((voice) => {
                var option = document.createElement("option");
                if (voiceSaved === voice.name) {
                    option.selected = true;
                }
                option.value = voice.name;
                option.text = voice.name + " (" + voice.lang + ")";
                select.appendChild(option);
            });
    }
}

function speak(){
    var text = document.getElementById("text").value;
    //get de voice selected
    voice = voices.filter(voice => voice.name === document.getElementById("voices").value)[0];
   if (voice == null) {
        alert("Please select a voice.");
        return;
    }
    var to_speak = new SpeechSynthesisUtterance(text);
    to_speak.voice = voice;
    window.speechSynthesis.speak(to_speak);
}

function saveVoice(){
    var voice = document.getElementById("voices").value;
    localStorage.setItem("voice", voice);
}

getVoices();
</script>

</html>